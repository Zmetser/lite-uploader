/* liteUploader v2.2.0 | https://github.com/burt202/lite-uploader | Aaron Burtnyk (http://www.burtdev.net) */

function LiteUploader(t,e){this.el=$(t),this.options=e,this.params=e.params,this.xhrs=[],this._init()}$.fn.liteUploader=function(t){var e={script:null,rules:{allowedFileTypes:null,maxSize:null},paramName:null,params:{},headers:{},changeHandler:!0,clickElement:null,singleFileUploads:!1,beforeRequest:function(t,e){return $.when(e)}};return this.each(function(){$.data(this,"liteUploader",new LiteUploader(this,$.extend(e,t)))})},LiteUploader.prototype={_init:function(){this.options.changeHandler&&this.el.change(function(){this._start()}.bind(this)),this.options.clickElement&&this.options.clickElement.click(function(){this._start()}.bind(this))},_start:function(){var t=this.el.get(0).files,e=this._getInputErrors(t);e||(e=this._getFileErrors(t)),e?(this.el.trigger("lu:errors",e),this._resetInput()):(this.el.trigger("lu:start",t),this._startUploadWithFiles(t))},_startUploadWithFiles:function(t){function e(){this.el.trigger("lu:before",[t]),this.options.beforeRequest(t,this._collateFormData(t)).done(this._performUpload.bind(this))}this.options.singleFileUploads?$.each(t,function(i){e.call(this,[t[i]])}.bind(this)):e.call(this,t)},_resetInput:function(){this.el.val("")},_getInputErrors:function(t){var e=[],i=[];return this.el.attr("name")||e.push({type:"fileInputNameRequired"}),this.options.script||e.push({type:"scriptOptionRequired"}),0===t.length&&e.push({type:"noFilesSelected"}),i.push({name:"liteUploader_input",errors:e}),e.length>0?[i]:null},_getFileErrors:function(t){var e=0,i=[];return $.each(t,function(s){var n=this._findErrorsForFile(t[s]);i.push({name:t[s].name,errors:n}),e+=n.length}.bind(this)),e>0?[i]:null},_findErrorsForFile:function(t){var e=[];return $.each(this.options.rules,function(i,s){"allowedFileTypes"===i&&s&&-1===$.inArray(t.type,s.split(","))&&e.push({type:"type",rule:s,given:t.type}),"maxSize"===i&&s&&t.size>s&&e.push({type:"size",rule:s,given:t.size})}),e},_getFormDataObject:function(){return new FormData},_collateFormData:function(t){var e=this._getFormDataObject(),i=this.options.paramName||this.el.attr("name");return this.el.attr("id")&&e.append("liteUploader_id",this.el.attr("id")),$.each(this.params,function(t,i){e.append(t,i)}),$.each(t,function(s){e.append(i,t[s])}),e},_buildXhrObject:function(){var t=new XMLHttpRequest;return t.upload.addEventListener("progress",this._onXHRProgress.bind(this),!1),this.xhrs.push(t),t},_performUpload:function(t){$.ajax({xhr:this._buildXhrObject.bind(this),url:this.options.script,type:"POST",data:t,headers:this.options.headers||{},processData:!1,contentType:!1}).done(this._onXHRSuccess.bind(this)).fail(this._onXHRFailure.bind(this)).always(this._onXHRAlways.bind(this))},_onXHRProgress:function(t){t.lengthComputable&&this.el.trigger("lu:progress",Math.floor(t.loaded/t.total*100))},_onXHRSuccess:function(t){this.el.trigger("lu:success",t)},_onXHRFailure:function(t){this.el.trigger("lu:fail",t)},_onXHRAlways:function(){this._resetInput()},addParam:function(t,e){this.params[t]=e},cancelUpload:function(){this.xhrs.forEach(function(t){t.abort()}),this.el.trigger("lu:cancelled"),this._resetInput()}};
